[Cherrypick] Refactor consensus commit prologue creation (#24529) (#2… · MystenLabs/sui@74e8414 · GitHub



[Skip to content](#start-of-content)








## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fcommit%2F74e8414a498601333fa4dd408c892f5fe3b0ca93)

Appearance settings

Search or jump to...


# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.


Include my email address so I can be contacted

Cancel
 Submit feedback





# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

Cancel
 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fcommit%2F74e8414a498601333fa4dd408c892f5fe3b0ca93)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcommit%2Fshow&source=header-repo&source_repo=MystenLabs%2Fsui)

Appearance settings

Resetting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.
 


Dismiss alert

{{ message }}

[MystenLabs](/MystenLabs) 
/
**[sui](/MystenLabs/sui)**
Public

* [Notifications](/login?return_to=%2FMystenLabs%2Fsui) You must be signed in to change notification settings
* [Fork
  11.7k](/login?return_to=%2FMystenLabs%2Fsui)
* [Star
   7.5k](/login?return_to=%2FMystenLabs%2Fsui)

# Commit 74e8414

[Browse files](/MystenLabs/sui/tree/74e8414a498601333fa4dd408c892f5fe3b0ca93)Browse files

[![mystenmark](https://avatars.githubusercontent.com/u/103447440?v=4&size=40)](/mystenmark)[mystenmark](/MystenLabs/sui/commits?author=mystenmark)

authored

[Cherrypick] Refactor consensus commit prologue creation ([#24529](https://github.com/MystenLabs/sui/pull/24529)) ([#24542](https://github.com/MystenLabs/sui/pull/24542))

- Refactor add\_consensus\_commit\_prologue so that we don't have to
recompute version assignments.
- Enable include\_cancelled\_randomness\_txns\_in\_prologue
- Remove old version of process\_transactions
Note: This exposed a pre-existing bug where cancelled randomness
transactions were not added to the commit prologue. The bug is fixed,
along with a protocol flag.

```move
1 parent 3395488 commit 74e8414

Copy full SHA for 74e8414
```

## File tree

Expand file treeCollapse file tree

## 10 files changed

+106

-38

lines changed

Open diff view settings

Filter options

* crates

  + sui-core/src

    - authority

      * [authority\_per\_epoch\_store.rs](#diff-aa15213f27146d723a24fa2f601ed46800fd70a4636f3081988c1c21912553bd)
      * [shared\_object\_version\_manager.rs](#diff-68d5c0274d653095b6e29863448f638a08aaa55eeb05549844bd381a915d9354)
    - [consensus\_handler.rs](#diff-8ccde7467e1b7899685cdb5469dc530bc63b1945339660881ad1267287d4e2e7)
    - execution\_scheduler

      * [execution\_scheduler\_impl.rs](#diff-575a72e9e068f57f52f87b553f0819967f11020f1f6ca975022d40c1d2cc913f)
  + sui-open-rpc/spec

    - [openrpc.json](#diff-8e6cee90a5dd9b610c3146fdb6fdd5e4215bfbb2cb634f4b099c74c9408c8c1d)
  + sui-protocol-config/src

    - [lib.rs](#diff-192add9c4d4ccc2ca9fc09a7309312d12593d58089ad08f51d17fa4b312719a2)
    - snapshots

      * [sui\_protocol\_config\_\_test\_\_Mainnet\_version\_104.snap](#diff-1a392d832e874f7f798911b4f7ecd1dd67352e06d35b283e98a9680c7016eff8)
      * [sui\_protocol\_config\_\_test\_\_Testnet\_version\_104.snap](#diff-3505966a8e36dc31d3d7966f2e0cde2ad374eefc8af7c15b3a93df5bda7de298)
      * [sui\_protocol\_config\_\_test\_\_version\_104.snap](#diff-e314b11cc416a3d829881727a89640d4ba0c05c83fa288c0864a132596e4bb70)
  + sui-types/src

    - [transaction.rs](#diff-a0688f15cc6395abf9f110d603bfb96a8b581cc3441f07322ad47a11e96749aa)

Expand file treeCollapse file tree

## 10 files changed

+106

-38

lines changed

Open diff view settings

Collapse file

### [`‎crates/sui-core/src/authority/authority_per_epoch_store.rs‎`](#diff-aa15213f27146d723a24fa2f601ed46800fd70a4636f3081988c1c21912553bd)

Copy file name to clipboardExpand all lines: crates/sui-core/src/authority/authority\_per\_epoch\_store.rs

+1Lines changed: 1 addition & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -2965,6 +2965,7 @@ impl AuthorityPerEpochStore {` | | | |
| `2965` | `2965` | `}` |
| `2966` | `2966` | `Schedulable::RandomnessStateUpdate(_, _) => None,` |
| `2967` | `2967` | `Schedulable::AccumulatorSettlement(_, _) => None,` |
|  | `2968` | `+ Schedulable::ConsensusCommitPrologue(_, _, _) => None,` |
| `2968` | `2969` | `})` |
| `2969` | `2970` | `.collect();` |
| `2970` | `2971` |  |
|  | | | |

Collapse file

### [`‎crates/sui-core/src/authority/shared_object_version_manager.rs‎`](#diff-68d5c0274d653095b6e29863448f638a08aaa55eeb05549844bd381a915d9354)

Copy file name to clipboardExpand all lines: crates/sui-core/src/authority/shared\_object\_version\_manager.rs

+19Lines changed: 19 additions & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -9,6 +9,8 @@ use std::collections::BTreeMap;` | | | |
| `9` | `9` | `use std::collections::HashMap;` |
| `10` | `10` | `use std::collections::HashSet;` |
| `11` | `11` | `use sui_types::SUI_ACCUMULATOR_ROOT_OBJECT_ID;` |
|  | `12` | `+ use sui_types::SUI_CLOCK_OBJECT_ID;` |
|  | `13` | `+ use sui_types::SUI_CLOCK_OBJECT_SHARED_VERSION;` |
| `12` | `14` | `use sui_types::base_types::ConsensusObjectSequenceKey;` |
| `13` | `15` | `use sui_types::base_types::TransactionDigest;` |
| `14` | `16` | `use sui_types::committee::EpochId;` |
| `@@ -79,6 +81,7 @@ pub enum Schedulable<T = VerifiedExecutableTransaction> {` | | | |
| `79` | `81` | `Transaction(T),` |
| `80` | `82` | `RandomnessStateUpdate(EpochId, RandomnessRound),` |
| `81` | `83` | `AccumulatorSettlement(EpochId, u64 /* checkpoint height */),` |
|  | `84` | `+ ConsensusCommitPrologue(EpochId, u64 /* round */, u32 /* sub_dag_index */),` |
| `82` | `85` | `}` |
| `83` | `86` |  |
| `84` | `87` | `impl From<VerifiedExecutableTransaction> for Schedulable<VerifiedExecutableTransaction> {` |
| `@@ -116,6 +119,9 @@ impl Schedulable<&'_ VerifiedExecutableTransaction> {` | | | |
| `116` | `119` | `Schedulable::AccumulatorSettlement(epoch, checkpoint_height) => {` |
| `117` | `120` | `Schedulable::AccumulatorSettlement(*epoch, *checkpoint_height)` |
| `118` | `121` | `}` |
|  | `122` | `+ Schedulable::ConsensusCommitPrologue(epoch, round, sub_dag_index) => {` |
|  | `123` | `+ Schedulable::ConsensusCommitPrologue(*epoch, *round, *sub_dag_index)` |
|  | `124` | `+ }` |
| `119` | `125` | `}` |
| `120` | `126` | `}` |
| `121` | `127` | `}` |
| `@@ -129,6 +135,7 @@ impl<T> Schedulable<T> {` | | | |
| `129` | `135` | `Schedulable::Transaction(tx) => Some(tx.as_tx()),` |
| `130` | `136` | `Schedulable::RandomnessStateUpdate(_, _) => None,` |
| `131` | `137` | `Schedulable::AccumulatorSettlement(_, _) => None,` |
|  | `138` | `+ Schedulable::ConsensusCommitPrologue(_, _, _) => None,` |
| `132` | `139` | `}` |
| `133` | `140` | `}` |
| `134` | `141` |  |
| `@@ -161,6 +168,13 @@ impl<T> Schedulable<T> {` | | | |
| `161` | `168` | `mutability: SharedObjectMutability::Mutable,` |
| `162` | `169` | `}))` |
| `163` | `170` | `}` |
|  | `171` | `+ Schedulable::ConsensusCommitPrologue(_, _, _) => {` |
|  | `172` | `+ Either::Right(std::iter::once(SharedInputObject {` |
|  | `173` | `+ id: SUI_CLOCK_OBJECT_ID,` |
|  | `174` | `+ initial_shared_version: SUI_CLOCK_OBJECT_SHARED_VERSION,` |
|  | `175` | `+ mutability: SharedObjectMutability::Mutable,` |
|  | `176` | `+ }))` |
|  | `177` | `+ }` |
| `164` | `178` | `}` |
| `165` | `179` | `}` |
| `166` | `180` |  |
| `@@ -173,6 +187,7 @@ impl<T> Schedulable<T> {` | | | |
| `173` | `187` | `.expect("Transaction input should have been verified"),` |
| `174` | `188` | `Schedulable::RandomnessStateUpdate(_, _) => vec![],` |
| `175` | `189` | `Schedulable::AccumulatorSettlement(_, _) => vec![],` |
|  | `190` | `+ Schedulable::ConsensusCommitPrologue(_, _, _) => vec![],` |
| `176` | `191` | `}` |
| `177` | `192` | `}` |
| `178` | `193` |  |
| `@@ -184,6 +199,7 @@ impl<T> Schedulable<T> {` | | | |
| `184` | `199` | `Schedulable::Transaction(tx) => transaction_receiving_object_keys(tx.as_tx()),` |
| `185` | `200` | `Schedulable::RandomnessStateUpdate(_, _) => vec![],` |
| `186` | `201` | `Schedulable::AccumulatorSettlement(_, _) => vec![],` |
|  | `202` | `+ Schedulable::ConsensusCommitPrologue(_, _, _) => vec![],` |
| `187` | `203` | `}` |
| `188` | `204` | `}` |
| `189` | `205` |  |
| `@@ -199,6 +215,9 @@ impl<T> Schedulable<T> {` | | | |
| `199` | `215` | `Schedulable::AccumulatorSettlement(epoch, checkpoint_height) => {` |
| `200` | `216` | `TransactionKey::AccumulatorSettlement(*epoch, *checkpoint_height)` |
| `201` | `217` | `}` |
|  | `218` | `+ Schedulable::ConsensusCommitPrologue(epoch, round, sub_dag_index) => {` |
|  | `219` | `+ TransactionKey::ConsensusCommitPrologue(*epoch, *round, *sub_dag_index)` |
|  | `220` | `+ }` |
| `202` | `221` | `}` |
| `203` | `222` | `}` |
| `204` | `223` | `}` |
|  | | | |

Collapse file

### [`‎crates/sui-core/src/consensus_handler.rs‎`](#diff-8ccde7467e1b7899685cdb5469dc530bc63b1945339660881ad1267287d4e2e7)

Copy file name to clipboardExpand all lines: crates/sui-core/src/consensus\_handler.rs

+63-38Lines changed: 63 additions & 38 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -29,6 +29,7 @@ use serde::{Deserialize, Serialize};` | | | |
| `29` | `29` | `use sui_macros::{fail_point, fail_point_arg, fail_point_if};` |
| `30` | `30` | `use sui_protocol_config::ProtocolConfig;` |
| `31` | `31` | `use sui_types::{` |
|  | `32` | `+ SUI_RANDOMNESS_STATE_OBJECT_ID,` |
| `32` | `33` | `authenticator_state::ActiveJwk,` |
| `33` | `34` | `base_types::{` |
| `34` | `35` | `AuthorityName, ConciseableName, ConsensusObjectSequenceKey, SequenceNumber,` |
| `@@ -44,7 +45,7 @@ use sui_types::{` | | | |
| `44` | `45` | `ExecutionTimeObservation,` |
| `45` | `46` | `},` |
| `46` | `47` | `sui_system_state::epoch_start_sui_system_state::EpochStartSystemStateTrait,` |
| `47` |  | `- transaction::{SenderSignedData, VerifiedCertificate, VerifiedTransaction},` |
|  | `48` | `+ transaction::{SenderSignedData, TransactionKey, VerifiedCertificate, VerifiedTransaction},` |
| `48` | `49` | `};` |
| `49` | `50` | `use tokio::{sync::MutexGuard, task::JoinSet};` |
| `50` | `51` | `use tracing::{debug, error, info, instrument, trace, warn};` |
| `@@ -62,7 +63,7 @@ use crate::{` | | | |
| `62` | `63` | `epoch_start_configuration::EpochStartConfigTrait,` |
| `63` | `64` | `execution_time_estimator::ExecutionTimeEstimator,` |
| `64` | `65` | `shared_object_congestion_tracker::SharedObjectCongestionTracker,` |
| `65` |  | `- shared_object_version_manager::{AssignedTxAndVersions, Schedulable, SharedObjVerManager},` |
|  | `66` | `+ shared_object_version_manager::{AssignedTxAndVersions, Schedulable},` |
| `66` | `67` | `transaction_deferral::{DeferralKey, DeferralReason, transaction_deferral_within_limit},` |
| `67` | `68` | `},` |
| `68` | `69` | `checkpoints::{` |
| `@@ -1230,22 +1231,23 @@ impl<C: CheckpointServiceNotify + Send + Sync> ConsensusHandler<C> {` | | | |
| `1230` | `1231` | `}` |
| `1231` | `1232` | `}` |
| `1232` | `1233` |  |
| `1233` |  | `- let consensus_commit_prologue = self.add_consensus_commit_prologue_transaction(` |
| `1234` |  | `- state,` |
| `1235` |  | `- commit_info,` |
| `1236` |  | `- transactions_to_schedule` |
| `1237` |  | `- .iter()` |
| `1238` |  | `- .map(Schedulable::Transaction),` |
| `1239` |  | `- &cancelled_txns,` |
| `1240` |  | `- );` |
|  | `1234` | `+ let consensus_commit_prologue = (!commit_info.skip_consensus_commit_prologue_in_test)` |
|  | `1235` | `+ .then_some(Schedulable::ConsensusCommitPrologue(` |
|  | `1236` | `+ epoch,` |
|  | `1237` | `+ commit_info.round,` |
|  | `1238` | `+ commit_info.consensus_commit_ref.index,` |
|  | `1239` | `+ ));` |
| `1241` | `1240` |  |
| `1242` | `1241` | `let schedulables: Vec<_> = itertools::chain!(` |
| `1243` | `1242` | `consensus_commit_prologue.into_iter(),` |
| `1244` |  | `- authenticator_state_update_transaction.into_iter(),` |
| `1245` |  | `- transactions_to_schedule.into_iter(),` |
|  | `1243` | `+ authenticator_state_update_transaction` |
|  | `1244` | `+ .into_iter()` |
|  | `1245` | `+ .map(Schedulable::Transaction),` |
|  | `1246` | `+ transactions_to_schedule` |
|  | `1247` | `+ .into_iter()` |
|  | `1248` | `+ .map(Schedulable::Transaction),` |
|  | `1249` | `+ settlement,` |
| `1246` | `1250` | `)` |
| `1247` |  | `- .map(Schedulable::Transaction)` |
| `1248` |  | `- .chain(settlement)` |
| `1249` | `1251` | `.collect();` |
| `1250` | `1252` |  |
| `1251` | `1253` | `let randomness_schedulables: Vec<_> = randomness_state_update_transaction` |
| `@@ -1269,6 +1271,24 @@ impl<C: CheckpointServiceNotify + Send + Sync> ConsensusHandler<C> {` | | | |
| `1269` | `1271` | `)` |
| `1270` | `1272` | `.expect("failed to assign shared object versions");` |
| `1271` | `1273` |  |
|  | `1274` | `+ let consensus_commit_prologue =` |
|  | `1275` | `+ self.add_consensus_commit_prologue_transaction(state, commit_info, &assigned_versions);` |
|  | `1276` | `+` |
|  | `1277` | `+ let mut schedulables = schedulables;` |
|  | `1278` | `+ let mut assigned_versions = assigned_versions;` |
|  | `1279` | `+ if let Some(consensus_commit_prologue) = consensus_commit_prologue {` |
|  | `1280` | `+ assert!(matches!(` |
|  | `1281` | `+ schedulables[0],` |
|  | `1282` | `+ Schedulable::ConsensusCommitPrologue(..)` |
|  | `1283` | `+ ));` |
|  | `1284` | `+ assert!(matches!(` |
|  | `1285` | `+ assigned_versions.0[0].0,` |
|  | `1286` | `+ TransactionKey::ConsensusCommitPrologue(..)` |
|  | `1287` | `+ ));` |
|  | `1288` | `+ assigned_versions.0[0].0 = TransactionKey::Digest(*consensus_commit_prologue.digest());` |
|  | `1289` | `+ schedulables[0] = Schedulable::Transaction(consensus_commit_prologue);` |
|  | `1290` | `+ }` |
|  | `1291` | `+` |
| `1272` | `1292` | `self.epoch_store` |
| `1273` | `1293` | `.process_user_signatures(schedulables.iter().chain(randomness_schedulables.iter()));` |
| `1274` | `1294` |  |
| `@@ -1282,35 +1302,40 @@ impl<C: CheckpointServiceNotify + Send + Sync> ConsensusHandler<C> {` | | | |
| `1282` | `1302` | `&'a self,` |
| `1283` | `1303` | `state: &'a mut CommitHandlerState,` |
| `1284` | `1304` | `commit_info: &'a ConsensusCommitInfo,` |
| `1285` |  | `- schedulables: impl Iterator<Item = Schedulable<&'a VerifiedExecutableTransaction>>,` |
| `1286` |  | `- cancelled_txns: &'a BTreeMap<TransactionDigest, CancelConsensusCertificateReason>,` |
|  | `1305` | `+ assigned_versions: &AssignedTxAndVersions,` |
| `1287` | `1306` | `) -> Option<VerifiedExecutableTransaction> {` |
| `1288` | `1307` | `{` |
| `1289` | `1308` | `if commit_info.skip_consensus_commit_prologue_in_test {` |
| `1290` | `1309` | `return None;` |
| `1291` | `1310` | `}` |
| `1292` | `1311` | `}` |
| `1293` | `1312` |  |
| `1294` |  | `- let mut version_assignment = Vec::new();` |
| `1295` |  | `- let mut shared_input_next_version = HashMap::new();` |
| `1296` |  | `- for txn in schedulables {` |
| `1297` |  | `- let key = txn.key();` |
| `1298` |  | `- match key.as_digest().and_then(|d| cancelled_txns.get(d)) {` |
| `1299` |  | `- Some(CancelConsensusCertificateReason::CongestionOnObjects(_))` |
| `1300` |  | `- | Some(CancelConsensusCertificateReason::DkgFailed) => {` |
| `1301` |  | `- assert_reachable!("cancelled transactions");` |
| `1302` |  | `- let assigned_versions = SharedObjVerManager::assign_versions_for_certificate(` |
| `1303` |  | `- &self.epoch_store,` |
| `1304` |  | `- &txn,` |
| `1305` |  | `- &mut shared_input_next_version,` |
| `1306` |  | `- cancelled_txns,` |
| `1307` |  | `- );` |
| `1308` |  | `- version_assignment.push((` |
| `1309` |  | `- *key.unwrap_digest(),` |
| `1310` |  | `- assigned_versions.shared_object_versions,` |
| `1311` |  | `- ));` |
| `1312` |  | `- }` |
| `1313` |  | `- None => {}` |
|  | `1313` | `+ let mut cancelled_txn_version_assignment = Vec::new();` |
|  | `1314` | `+` |
|  | `1315` | `+ let protocol_config = self.epoch_store.protocol_config();` |
|  | `1316` | `+` |
|  | `1317` | `+ for (txn_key, assigned_versions) in assigned_versions.0.iter() {` |
|  | `1318` | `+ let Some(d) = txn_key.as_digest() else {` |
|  | `1319` | `+ continue;` |
|  | `1320` | `+ };` |
|  | `1321` | `+` |
|  | `1322` | `+ if !protocol_config.include_cancelled_randomness_txns_in_prologue()` |
|  | `1323` | `+ && assigned_versions` |
|  | `1324` | `+ .shared_object_versions` |
|  | `1325` | `+ .iter()` |
|  | `1326` | `+ .any(|((id, _), _)| *id == SUI_RANDOMNESS_STATE_OBJECT_ID)` |
|  | `1327` | `+ {` |
|  | `1328` | `+ continue;` |
|  | `1329` | `+ }` |
|  | `1330` | `+` |
|  | `1331` | `+ if assigned_versions` |
|  | `1332` | `+ .shared_object_versions` |
|  | `1333` | `+ .iter()` |
|  | `1334` | `+ .any(|(_, version)| version.is_cancelled())` |
|  | `1335` | `+ {` |
|  | `1336` | `+ assert_reachable!("cancelled transactions");` |
|  | `1337` | `+ cancelled_txn_version_assignment` |
|  | `1338` | `+ .push((*d, assigned_versions.shared_object_versions.clone()));` |
| `1314` | `1339` | `}` |
| `1315` | `1340` | `}` |
| `1316` | `1341` |  |
| `@@ -1320,14 +1345,14 @@ impl<C: CheckpointServiceNotify + Send + Sync> ConsensusHandler<C> {` | | | |
| `1320` | `1345` | `TransactionDigest,` |
| `1321` | `1346` | `Vec<(ConsensusObjectSequenceKey, SequenceNumber)>` |
| `1322` | `1347` | `)>| {` |
| `1323` |  | `- version_assignment.extend(additional_cancelled_txns);` |
|  | `1348` | `+ cancelled_txn_version_assignment.extend(additional_cancelled_txns);` |
| `1324` | `1349` | `}` |
| `1325` | `1350` | `);` |
| `1326` | `1351` |  |
| `1327` | `1352` | `let transaction = commit_info.create_consensus_commit_prologue_transaction(` |
| `1328` | `1353` | `self.epoch_store.epoch(),` |
| `1329` | `1354` | `self.epoch_store.protocol_config(),` |
| `1330` |  | `- version_assignment,` |
|  | `1355` | `+ cancelled_txn_version_assignment,` |
| `1331` | `1356` | `commit_info,` |
| `1332` | `1357` | `state.indirect_state_observer.take().unwrap(),` |
| `1333` | `1358` | `);` |
|  | | | |

Collapse file

### [`‎crates/sui-core/src/execution_scheduler/execution_scheduler_impl.rs‎`](#diff-575a72e9e068f57f52f87b553f0819967f11020f1f6ca975022d40c1d2cc913f)

Copy file name to clipboardExpand all lines: crates/sui-core/src/execution\_scheduler/execution\_scheduler\_impl.rs

+6Lines changed: 6 additions & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -519,6 +519,12 @@ impl ExecutionScheduler {` | | | |
| `519` | `519` | `Schedulable::AccumulatorSettlement(_, _) => {` |
| `520` | `520` | `settlement_txns.push((schedulable.key(), env));` |
| `521` | `521` | `}` |
|  | `522` | `+ Schedulable::ConsensusCommitPrologue(_, _, _) => {` |
|  | `523` | `+ // we only use Schedulable::ConsensusCommitPrologue as a temporary placeholder` |
|  | `524` | `+ // during version assignment, by the time we schedule transactions it should be` |
|  | `525` | `+ // converted to Schedulable::Transaction` |
|  | `526` | `+ unreachable!("Schedulable::ConsensusCommitPrologue should not be enqueued");` |
|  | `527` | `+ }` |
| `522` | `528` | `}` |
| `523` | `529` | `}` |
| `524` | `530` |  |
|  | | | |

Collapse file

### [`‎crates/sui-open-rpc/spec/openrpc.json‎`](#diff-8e6cee90a5dd9b610c3146fdb6fdd5e4215bfbb2cb634f4b099c74c9408c8c1d)

Copy file name to clipboardExpand all lines: crates/sui-open-rpc/spec/openrpc.json

+1Lines changed: 1 addition & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -1365,6 +1365,7 @@` | | | |
| `1365` | `1365` | `"generate_df_type_layouts": false,` |
| `1366` | `1366` | `"hardened_otw_check": false,` |
| `1367` | `1367` | `"ignore_execution_time_observations_after_certs_closed": false,` |
|  | `1368` | `+ "include_cancelled_randomness_txns_in_prologue": false,` |
| `1368` | `1369` | `"include_checkpoint_artifacts_digest_in_summary": false,` |
| `1369` | `1370` | `"include_consensus_digest_in_prologue": false,` |
| `1370` | `1371` | `"loaded_child_object_format": false,` |
|  | | | |

Collapse file

### [`‎crates/sui-protocol-config/src/lib.rs‎`](#diff-192add9c4d4ccc2ca9fc09a7309312d12593d58089ad08f51d17fa4b312719a2)

Copy file name to clipboardExpand all lines: crates/sui-protocol-config/src/lib.rs

+12Lines changed: 12 additions & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -894,6 +894,10 @@ struct FeatureFlags {` | | | |
| `894` | `894` | `// If true, skip GC'ed accept votes in CommitFinalizer.` |
| `895` | `895` | `#[serde(skip_serializing_if = "is_false")]` |
| `896` | `896` | `consensus_skip_gced_accept_votes: bool,` |
|  | `897` | `+` |
|  | `898` | `+ // If true, include cancelled randomness txns in the consensus commit prologue.` |
|  | `899` | `+ #[serde(skip_serializing_if = "is_false")]` |
|  | `900` | `+ include_cancelled_randomness_txns_in_prologue: bool,` |
| `897` | `901` | `}` |
| `898` | `902` |  |
| `899` | `903` | `fn is_false(b: &bool) -> bool {` |
| `@@ -2408,6 +2412,11 @@ impl ProtocolConfig {` | | | |
| `2408` | `2412` | `pub fn consensus_skip_gced_accept_votes(&self) -> bool {` |
| `2409` | `2413` | `self.feature_flags.consensus_skip_gced_accept_votes` |
| `2410` | `2414` | `}` |
|  | `2415` | `+` |
|  | `2416` | `+ pub fn include_cancelled_randomness_txns_in_prologue(&self) -> bool {` |
|  | `2417` | `+ self.feature_flags` |
|  | `2418` | `+ .include_cancelled_randomness_txns_in_prologue` |
|  | `2419` | `+ }` |
| `2411` | `2420` | `}` |
| `2412` | `2421` |  |
| `2413` | `2422` | `#[cfg(not(msim))]` |
| `@@ -4293,6 +4302,9 @@ impl ProtocolConfig {` | | | |
| `4293` | `4302` | `cfg.feature_flags` |
| `4294` | `4303` | `.enable_nitro_attestation_all_nonzero_pcrs_parsing = true;` |
| `4295` | `4304` | `}` |
|  | `4305` | `+` |
|  | `4306` | `+ cfg.feature_flags` |
|  | `4307` | `+ .include_cancelled_randomness_txns_in_prologue = true;` |
| `4296` | `4308` | `}` |
| `4297` | `4309` | `// Use this template when making changes:` |
| `4298` | `4310` | `//` |
|  | | | |

Collapse file

### [`‎crates/sui-protocol-config/src/snapshots/sui_protocol_config__test__Mainnet_version_104.snap‎`](#diff-1a392d832e874f7f798911b4f7ecd1dd67352e06d35b283e98a9680c7016eff8)

Copy file name to clipboardExpand all lines: crates/sui-protocol-config/src/snapshots/sui\_protocol\_config\_\_test\_\_Mainnet\_version\_104.snap

+1Lines changed: 1 addition & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -127,6 +127,7 @@ feature_flags:` | | | |
| `127` | `127` | `private_generics_verifier_v2: true` |
| `128` | `128` | `deprecate_global_storage_ops: true` |
| `129` | `129` | `consensus_skip_gced_accept_votes: true` |
|  | `130` | `+ include_cancelled_randomness_txns_in_prologue: true` |
| `130` | `131` | `max_tx_size_bytes: 131072` |
| `131` | `132` | `max_input_objects: 2048` |
| `132` | `133` | `max_size_written_objects: 5000000` |
|  | | | |

Collapse file

### [`‎crates/sui-protocol-config/src/snapshots/sui_protocol_config__test__Testnet_version_104.snap‎`](#diff-3505966a8e36dc31d3d7966f2e0cde2ad374eefc8af7c15b3a93df5bda7de298)

Copy file name to clipboardExpand all lines: crates/sui-protocol-config/src/snapshots/sui\_protocol\_config\_\_test\_\_Testnet\_version\_104.snap

+1Lines changed: 1 addition & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -129,6 +129,7 @@ feature_flags:` | | | |
| `129` | `129` | `private_generics_verifier_v2: true` |
| `130` | `130` | `deprecate_global_storage_ops: true` |
| `131` | `131` | `consensus_skip_gced_accept_votes: true` |
|  | `132` | `+ include_cancelled_randomness_txns_in_prologue: true` |
| `132` | `133` | `max_tx_size_bytes: 131072` |
| `133` | `134` | `max_input_objects: 2048` |
| `134` | `135` | `max_size_written_objects: 5000000` |
|  | | | |

Collapse file

### [`‎crates/sui-protocol-config/src/snapshots/sui_protocol_config__test__version_104.snap‎`](#diff-e314b11cc416a3d829881727a89640d4ba0c05c83fa288c0864a132596e4bb70)

Copy file name to clipboardExpand all lines: crates/sui-protocol-config/src/snapshots/sui\_protocol\_config\_\_test\_\_version\_104.snap

+1Lines changed: 1 addition & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -132,6 +132,7 @@ feature_flags:` | | | |
| `132` | `132` | `private_generics_verifier_v2: true` |
| `133` | `133` | `deprecate_global_storage_ops: true` |
| `134` | `134` | `consensus_skip_gced_accept_votes: true` |
|  | `135` | `+ include_cancelled_randomness_txns_in_prologue: true` |
| `135` | `136` | `max_tx_size_bytes: 131072` |
| `136` | `137` | `max_input_objects: 2048` |
| `137` | `138` | `max_size_written_objects: 5000000` |
|  | | | |

Collapse file

### [`‎crates/sui-types/src/transaction.rs‎`](#diff-a0688f15cc6395abf9f110d603bfb96a8b581cc3441f07322ad47a11e96749aa)

Copy file name to clipboardExpand all lines: crates/sui-types/src/transaction.rs

+1Lines changed: 1 addition & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -4250,6 +4250,7 @@ pub enum TransactionKey {` | | | |
| `4250` | `4250` | `Digest(TransactionDigest),` |
| `4251` | `4251` | `RandomnessRound(EpochId, RandomnessRound),` |
| `4252` | `4252` | `AccumulatorSettlement(EpochId, u64 /* checkpoint height */),` |
|  | `4253` | `+ ConsensusCommitPrologue(EpochId, u64 /* round */, u32 /* sub_dag_index */),` |
| `4253` | `4254` | `}` |
| `4254` | `4255` |  |
| `4255` | `4256` | `impl TransactionKey {` |
|  | | | |

## 0 commit comments

Comments

0 (0)

You can’t perform that action at this time.