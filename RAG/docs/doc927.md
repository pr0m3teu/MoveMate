Increase checkpoint message size limit in ingestion client (#24313) (… · MystenLabs/sui@edfb00f · GitHub



[Skip to content](#start-of-content)








## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fcommit%2Fedfb00f26f1e5d967a71ccba828e6c01dfb9db0d)

Appearance settings

Search or jump to...


# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.


Include my email address so I can be contacted

Cancel
 Submit feedback





# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

Cancel
 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fcommit%2Fedfb00f26f1e5d967a71ccba828e6c01dfb9db0d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcommit%2Fshow&source=header-repo&source_repo=MystenLabs%2Fsui)

Appearance settings

Resetting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.
 


Dismiss alert

{{ message }}

[MystenLabs](/MystenLabs) 
/
**[sui](/MystenLabs/sui)**
Public

* [Notifications](/login?return_to=%2FMystenLabs%2Fsui) You must be signed in to change notification settings
* [Fork
  11.7k](/login?return_to=%2FMystenLabs%2Fsui)
* [Star
   7.5k](/login?return_to=%2FMystenLabs%2Fsui)

# Commit edfb00f

[Browse files](/MystenLabs/sui/tree/edfb00f26f1e5d967a71ccba828e6c01dfb9db0d)Browse files

[![nickvikeras](https://avatars.githubusercontent.com/u/1908006?v=4&size=40)](/nickvikeras)[nickvikeras](/MystenLabs/sui/commits?author=nickvikeras)

authored

Increase checkpoint message size limit in ingestion client ([#24313](https://github.com/MystenLabs/sui/pull/24313)) ([#24329](https://github.com/MystenLabs/sui/pull/24329))

## Description
We were seeing client-side errors due to messages that exceeded the
default 4mb limit. Bumping it up to 128mb (the biggest I've seen so far
is ~90mb).

```move
1 parent f8988d9 commit edfb00f

Copy full SHA for edfb00f
```

## File tree

Expand file treeCollapse file tree

## 3 files changed

+10

-2

lines changed

Open diff view settings

Filter options

* crates/sui-indexer-alt-framework/src/ingestion

  + [client.rs](#diff-a228bf14878a38916104147d9ad7336d53edffb5787ad1580f96cea45a34a1d3)
  + [mod.rs](#diff-35f6c2c15fbcd31e619eb65d89ec522dbf5b29b655f46cd49d47e02f23c3394d)
  + [streaming\_client.rs](#diff-633f7fd174be7ce38b9196a818fff1f7f5d9fa91cb87ac1f6d92ac997198c756)

Expand file treeCollapse file tree

## 3 files changed

+10

-2

lines changed

Open diff view settings

Collapse file

### [`‎crates/sui-indexer-alt-framework/src/ingestion/client.rs‎`](#diff-a228bf14878a38916104147d9ad7336d53edffb5787ad1580f96cea45a34a1d3)

Copy file name to clipboardExpand all lines: crates/sui-indexer-alt-framework/src/ingestion/client.rs

+5-1Lines changed: 5 additions & 1 deletion

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -16,6 +16,7 @@ use tracing::{debug, error, warn};` | | | |
| `16` | `16` | `use url::Url;` |
| `17` | `17` |  |
| `18` | `18` | `use crate::ingestion::Error as IngestionError;` |
|  | `19` | `+ use crate::ingestion::MAX_GRPC_MESSAGE_SIZE_BYTES;` |
| `19` | `20` | `use crate::ingestion::Result as IngestionResult;` |
| `20` | `21` | `use crate::ingestion::local_client::LocalIngestionClient;` |
| `21` | `22` | `use crate::ingestion::remote_client::RemoteIngestionClient;` |
| `@@ -105,9 +106,12 @@ impl IngestionClient {` | | | |
| `105` | `106` | `let client = if let Some(username) = username {` |
| `106` | `107` | `let mut headers = HeadersInterceptor::new();` |
| `107` | `108` | `headers.basic_auth(username, password);` |
| `108` |  | `- Client::new(url.to_string())?.with_headers(headers)` |
|  | `109` | `+ Client::new(url.to_string())?` |
|  | `110` | `+ .with_headers(headers)` |
|  | `111` | `+ .with_max_decoding_message_size(MAX_GRPC_MESSAGE_SIZE_BYTES)` |
| `109` | `112` | `} else {` |
| `110` | `113` | `Client::new(url.to_string())?` |
|  | `114` | `+ .with_max_decoding_message_size(MAX_GRPC_MESSAGE_SIZE_BYTES)` |
| `111` | `115` | `};` |
| `112` | `116` | `Ok(Self::new_impl(Arc::new(client), metrics))` |
| `113` | `117` | `}` |
|  | | | |

Collapse file

### [`‎crates/sui-indexer-alt-framework/src/ingestion/mod.rs‎`](#diff-35f6c2c15fbcd31e619eb65d89ec522dbf5b29b655f46cd49d47e02f23c3394d)

Copy file name to clipboardExpand all lines: crates/sui-indexer-alt-framework/src/ingestion/mod.rs

+2Lines changed: 2 additions & 0 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -31,6 +31,8 @@ mod streaming_client;` | | | |
| `31` | `31` | `#[cfg(test)]` |
| `32` | `32` | `mod test_utils;` |
| `33` | `33` |  |
|  | `34` | `+ pub(crate) const MAX_GRPC_MESSAGE_SIZE_BYTES: usize = 128 * 1024 * 1024;` |
|  | `35` | `+` |
| `34` | `36` | `#[derive(clap::Args, Clone, Debug, Default)]` |
| `35` | `37` | `#[group(required = true)]` |
| `36` | `38` | `pub struct ClientArgs {` |
|  | | | |

Collapse file

### [`‎crates/sui-indexer-alt-framework/src/ingestion/streaming_client.rs‎`](#diff-633f7fd174be7ce38b9196a818fff1f7f5d9fa91cb87ac1f6d92ac997198c756)

Copy file name to clipboardExpand all lines: crates/sui-indexer-alt-framework/src/ingestion/streaming\_client.rs

+3-1Lines changed: 3 additions & 1 deletion

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -11,6 +11,7 @@ use sui_rpc::proto::sui::rpc::v2::{` | | | |
| `11` | `11` | `use sui_rpc_api::client::checkpoint_data_field_mask;` |
| `12` | `12` | `use tonic::{Status, transport::Uri};` |
| `13` | `13` |  |
|  | `14` | `+ use crate::ingestion::MAX_GRPC_MESSAGE_SIZE_BYTES;` |
| `14` | `15` | `use crate::ingestion::error::{Error, Result};` |
| `15` | `16` | `use crate::types::full_checkpoint_content::Checkpoint;` |
| `16` | `17` |  |
| `@@ -39,7 +40,8 @@ impl CheckpointStreamingClient for GrpcStreamingClient {` | | | |
| `39` | `40` | `async fn connect(&mut self) -> Result<CheckpointStream> {` |
| `40` | `41` | `let mut client = SubscriptionServiceClient::connect(self.uri.clone())` |
| `41` | `42` | `.await` |
| `42` |  | `- .map_err(|err| Error::RpcClientError(Status::from_error(err.into())))?;` |
|  | `43` | `+ .map_err(|err| Error::RpcClientError(Status::from_error(err.into())))?` |
|  | `44` | `+ .max_decoding_message_size(MAX_GRPC_MESSAGE_SIZE_BYTES);` |
| `43` | `45` |  |
| `44` | `46` | `let mut request = SubscribeCheckpointsRequest::default();` |
| `45` | `47` | `request.read_mask = Some(checkpoint_data_field_mask());` |
|  | | | |

## 0 commit comments

Comments

0 (0)

You can’t perform that action at this time.