fix(graphql): filter wrapped/deleted object versions by amnn · Pull Request #24202 · MystenLabs/sui · GitHub



[Skip to content](#start-of-content)







## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fpull%2F24202)

Appearance settings

Search or jump to...


# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.


Include my email address so I can be contacted

Cancel
 Submit feedback





# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

Cancel
 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fpull%2F24202)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=MystenLabs%2Fsui)

Appearance settings

Resetting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.
 


Dismiss alert

{{ message }}

[MystenLabs](/MystenLabs) 
/
**[sui](/MystenLabs/sui)**
Public

* [Notifications](/login?return_to=%2FMystenLabs%2Fsui) You must be signed in to change notification settings
* [Fork
  11.7k](/login?return_to=%2FMystenLabs%2Fsui)
* [Star
   7.5k](/login?return_to=%2FMystenLabs%2Fsui)

# fix(graphql): filter wrapped/deleted object versions #24202

New issue

 

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

[Sign up for GitHub](/signup?return_to=%2FMystenLabs%2Fsui%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FMystenLabs%2Fsui%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

Merged

[amnn](/amnn)
merged 1 commit into
[main](/MystenLabs/sui/tree/main "MystenLabs/sui:main")
from
[amnn/gql-obj-v](/MystenLabs/sui/tree/amnn/gql-obj-v "MystenLabs/sui:amnn/gql-obj-v")








Nov 11, 2025

Merged

# [fix(graphql): filter wrapped/deleted object versions](#top) #24202

[amnn](/amnn)
merged 1 commit into
[main](/MystenLabs/sui/tree/main "MystenLabs/sui:main")
from
[amnn/gql-obj-v](/MystenLabs/sui/tree/amnn/gql-obj-v "MystenLabs/sui:amnn/gql-obj-v")








Nov 11, 2025

### Uh oh!

There was an error while loading. Please reload this page.

## Conversation

This file contains hidden or bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

[Show hidden characters]({{ revealButtonHref }})








[![@amnn](https://avatars.githubusercontent.com/u/332275?s=80&v=4)](/amnn)

Copy link

Contributor

### @amnn **[amnn](/amnn)** commented [Nov 7, 2025](#issue-3602069454)

## Description

When paginating object versions, we need to filter out the versions corresponding to wrapped/deleted objects in `obj_versions`. They exist as rows in `obj_versions` so we know when an object has been deleted/wrapped as of a particular checkpoint, but we will fail to fetch contents for that entry (obviously).

## Test plan

New E2E test:

```move
$ cargo nextest run            \
  -p sui-indexer-alt-e2e-tests \
  -- object_version_wrapping
```

Also confirmed that the change still results in a good query plan by testing the following GraphQL query:

```move
{
  objectVersions(address: "0x6", first: 50) {
    nodes {
      address
      version
      digest
    }
  }
}
```

Which results in the following SQL query:

```move
EXPLAIN ANALYZE
SELECT "obj_versions"."object_id", "obj_versions"."object_version", "obj_versions"."object_digest", "obj_versions"."cp_sequence_number"
FROM "obj_versions"
WHERE ((("obj_versions"."object_id" = '\x0000000000000000000000000000000000000000000000000000000000000006'::bytea)
    AND ("obj_versions"."object_digest" IS NOT NULL))
    AND object_version <= (
        SELECT m.object_version
        FROM obj_versions m
        WHERE m.object_id = obj_versions.object_id
        AND m.cp_sequence_number <= 209005383
        ORDER BY m.cp_sequence_number DESC, m.object_version DESC
        LIMIT 1
    )
)
ORDER BY "obj_versions"."object_version"
LIMIT 52;
```

Producing the following query plan:

```move
 Limit  (cost=0.84..892.36 rows=52 width=82) (actual time=0.110..0.504 rows=52 loops=1)
   ->  Index Scan using obj_versions_pkey on obj_versions  (cost=0.84..2944780166.37 rows=171760972 width=82) (actual time=0.107..0.495 rows=52 loops=1)
         Index Cond: (object_id = '\x0000000000000000000000000000000000000000000000000000000000000006'::bytea)
         Filter: ((object_digest IS NOT NULL) AND (object_version <= (SubPlan 1)))
         SubPlan 1
           ->  Limit  (cost=0.84..1.00 rows=1 width=16) (actual time=0.007..0.008 rows=1 loops=52)
                 ->  Index Only Scan using obj_versions_id_cp_version on obj_versions m  (cost=0.84..96585.19 rows=583857 width=16) (actual time=0.007..0.007 rows=1 loops=52)
                       Index Cond: ((object_id = obj_versions.object_id) AND (cp_sequence_number <= 209005383))
                       Heap Fetches: 52
 Planning Time: 0.426 ms
 Execution Time: 0.568 ms
```

Which runs quickly and is identical to the old query plan excluding the extra filter condition.

---

## Release notes

Check each box that your changes affect. If none of the boxes relate to your changes, release notes aren't required.

For each box you select, include information after the relevant heading that describes the impact of your changes that a user might notice and any actions they must take to implement updates.

* Protocol:
* Nodes (Validators and Full nodes):
* gRPC:
* JSON-RPC:
* GraphQL: Fixes a bug related to paginating object versions for an object that has been deleted/wrapped at some point.
* CLI:
* Rust SDK:
* Indexing Framework:

Sorry, something went wrong.

### Uh oh!

There was an error while loading. Please reload this page.

All reactions

[![@amnn](https://avatars.githubusercontent.com/u/332275?s=40&v=4)](/amnn)

`fix(graphql): filter wrapped/deleted object versions`

 …

`52d33c2`

```move
## Description

When paginating object versions, we need to filter out the versions
corresponding to wrapped/deleted objects in `obj_versions`. They exist
as rows in `obj_versions` so we know when an object has been
deleted/wrapped as of a particular checkpoint, but we will fail to fetch
contents for that entry (obviously).

## Test plan

New E2E test:

```
$ cargo nextest run            \
  -p sui-indexer-alt-e2e-tests \
  -- object_version_wrapping
```

Also confirmed that the change still results in a good query plan by
testing the following GraphQL query:

```graphql
{
  objectVersions(address: "0x6", first: 50) {
    nodes {
      address
      version
      digest
    }
  }
}
```

Which results in the following SQL query:

```
EXPLAIN ANALYZE
SELECT "obj_versions"."object_id", "obj_versions"."object_version", "obj_versions"."object_digest", "obj_versions"."cp_sequence_number"
FROM "obj_versions"
WHERE ((("obj_versions"."object_id" = '\x0000000000000000000000000000000000000000000000000000000000000006'::bytea)
    AND ("obj_versions"."object_digest" IS NOT NULL))
    AND object_version <= (
        SELECT m.object_version
        FROM obj_versions m
        WHERE m.object_id = obj_versions.object_id
        AND m.cp_sequence_number <= 209005383
        ORDER BY m.cp_sequence_number DESC, m.object_version DESC
        LIMIT 1
    )
)
ORDER BY "obj_versions"."object_version"
LIMIT 52;
```

Producing the following query plan:

```
 Limit  (cost=0.84..892.36 rows=52 width=82) (actual time=0.110..0.504 rows=52 loops=1)
   ->  Index Scan using obj_versions_pkey on obj_versions  (cost=0.84..2944780166.37 rows=171760972 width=82) (actual time=0.107..0.495 rows=52 loops=1)
         Index Cond: (object_id = '\x0000000000000000000000000000000000000000000000000000000000000006'::bytea)
         Filter: ((object_digest IS NOT NULL) AND (object_version <= (SubPlan 1)))
         SubPlan 1
           ->  Limit  (cost=0.84..1.00 rows=1 width=16) (actual time=0.007..0.008 rows=1 loops=52)
                 ->  Index Only Scan using obj_versions_id_cp_version on obj_versions m  (cost=0.84..96585.19 rows=583857 width=16) (actual time=0.007..0.007 rows=1 loops=52)
                       Index Cond: ((object_id = obj_versions.object_id) AND (cp_sequence_number <= 209005383))
                       Heap Fetches: 52
 Planning Time: 0.426 ms
 Execution Time: 0.568 ms
```

Which runs quickly and is identical to the old query plan excluding the
extra filter condition.
```

[![@amnn](https://avatars.githubusercontent.com/u/332275?s=40&u=fbf218c7e4a657c413a08873087b3f79c535da22&v=4)](/amnn)
[amnn](/amnn)
self-assigned this
[Nov 7, 2025](#event-20798871458)

[![@amnn](https://avatars.githubusercontent.com/u/332275?s=40&u=fbf218c7e4a657c413a08873087b3f79c535da22&v=4)](/amnn)
[amnn](/amnn)
requested a review
from a team
as a [code owner](/MystenLabs/sui/blob/30006ca846babaee34577a048fa4fbaeb0b860c5/.github/CODEOWNERS#L20)
[November 7, 2025 21:22](#event-20798871553)

[![@amnn](https://avatars.githubusercontent.com/u/332275?s=40&u=fbf218c7e4a657c413a08873087b3f79c535da22&v=4)](/amnn)
[amnn](/amnn)
requested review from
[emmazzz](/emmazzz),
[evan-wall-mysten](/evan-wall-mysten),
[henryachen](/henryachen),
[tpham-mysten](/tpham-mysten) and
[wlmyng](/wlmyng)
[November 7, 2025 21:22](#event-20798871613)

[![@amnn](https://avatars.githubusercontent.com/u/332275?s=40&u=fbf218c7e4a657c413a08873087b3f79c535da22&v=4)](/amnn)
[amnn](/amnn)
[temporarily deployed](https://github.com/MystenLabs/sui/actions/runs/19181586416/job/54839405920)
to
sui-typescript-aws-kms-test-env
[November 7, 2025 21:22](#event-20798872188) — with ![](https://avatars.githubusercontent.com/in/15368?s=40&u=167a342ed94d2a713daf64a8b476ead2cebe1852&v=4)
[GitHub Actions](https://github.com/apps/github-actions)

Inactive

[![@vercel](https://avatars.githubusercontent.com/in/8329?s=80&v=4)](/apps/vercel)

Copy link

### **[vercel](/apps/vercel) bot** commented [Nov 7, 2025](#issuecomment-3505032359) • edited Loading Uh oh! There was an error while loading. Please reload this page.

|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| The latest updates on your projects. Learn more about [Vercel for GitHub](https://vercel.link/github-learn-more).   | Project | Deployment | Preview | Comments | Updated (UTC) | | --- | --- | --- | --- | --- | | [sui-docs](https://vercel.com/sui-foundation/sui-docs) | [Ready](https://camo.githubusercontent.com/2d058aa4937109084c3b00dc259081ef9f01257a8504a292a286041635575d96/68747470733a2f2f76657263656c2e636f6d2f7374617469632f7374617475732f72656164792e737667) [Ready](https://vercel.com/sui-foundation/sui-docs/DN8VikV5AkrJRV1DYCMyLbPWPi6Q) | [Preview](https://sui-docs-git-amnn-gql-obj-v-sui-foundation.vercel.app) | [Comment](https://vercel.live/open-feedback/sui-docs-git-amnn-gql-obj-v-sui-foundation.vercel.app?via=pr-comment-feedback-link) | Nov 7, 2025 9:23pm |  2 Skipped Deployments   | Project | Deployment | Preview | Comments | Updated (UTC) | | --- | --- | --- | --- | --- | | [multisig-toolkit](https://vercel.com/mysten-labs/multisig-toolkit) | [Ignored](https://camo.githubusercontent.com/6af980227b4c827b4b58e336e17b2523b7763da7d328256138bdddcbbe31ecbb/68747470733a2f2f76657263656c2e636f6d2f7374617469632f7374617475732f63616e63656c65642e737667) [Ignored](https://vercel.com/mysten-labs/multisig-toolkit/C8WDW6yJrQjTrJGwjxRYaxNvVacz) |  |  | Nov 7, 2025 9:23pm | | [sui-kiosk](https://vercel.com/mysten-labs/sui-kiosk) | [Ignored](https://camo.githubusercontent.com/6af980227b4c827b4b58e336e17b2523b7763da7d328256138bdddcbbe31ecbb/68747470733a2f2f76657263656c2e636f6d2f7374617469632f7374617475732f63616e63656c65642e737667) [Ignored](https://vercel.com/mysten-labs/sui-kiosk/D2Txw3LGKWFPTyyxzMw5ZqhVtvvx) |  |  | Nov 7, 2025 9:23pm | |

All reactions

Sorry, something went wrong.

### Uh oh!

There was an error while loading. Please reload this page.

[![@vercel](https://avatars.githubusercontent.com/in/8329?s=40&v=4)](/apps/vercel)
[vercel](/apps/vercel)
bot
[deployed](https://sui-docs-9y7qatktq-sui-foundation.vercel.app "Deployment has completed")
to
[Preview – sui-docs](https://sui-docs-9y7qatktq-sui-foundation.vercel.app)
[November 7, 2025 21:23](#event-20798896228)
[View deployment](https://sui-docs-9y7qatktq-sui-foundation.vercel.app)

[![henryachen](https://avatars.githubusercontent.com/u/8963934?s=60&v=4)](/henryachen)

**[henryachen](/henryachen)**
reviewed
[Nov 11, 2025](#pullrequestreview-3446025539)

[View reviewed changes](/MystenLabs/sui/pull/24202/files/52d33c2c57076c852a6e0ad824eead76ab52fc5f)

[crates/sui-indexer-alt-e2e-tests/tests/graphql/objects/object\_version\_wrapping.snap](/MystenLabs/sui/pull/24202/files/52d33c2c57076c852a6e0ad824eead76ab52fc5f#diff-8f7fe67afdc4003385eefcc7cf2fbb54d89a71e506d5b98e5f19892ce33d3c0d)

|  |  |  |
| --- | --- | --- |
|  |  | "json": { |
|  |  | "balance": "41", |
|  |  | "id": "0x0d3cdda4062f7fc8c47b50b6db0d053d8c4eaa841bc152a1b1ffdbe0915a180c" |
|  |  | } |

Copy link

Collaborator

### @henryachen **[henryachen](/henryachen)** [Nov 11, 2025](#discussion_r2512653592) • edited Loading Uh oh! There was an error while loading. Please reload this page.

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason
Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved
 
Hide comment

For learning purposes, if an object is wrapped it should never show up in `objectVersions` queries because we can no longer find the wrapped object contents by ID / version?

So in the case of this test, even if there is a function on the module that adds balance to a wrapped coin

```move
module P::M {
...
  public fun add_balance(wrapper: &mut Wrapper, coin: Coin<SUI>) {
    wrapper.coin.join(coin);
  }
}
```

when `add_balance` is called before `unwrap`, it will increment the version and update balance in this case but will not show up in the `objectVersions` response.

Sorry, something went wrong.

### Uh oh!

There was an error while loading. Please reload this page.

All reactions

Copy link

Contributor

Author

### @amnn **[amnn](/amnn)** [Nov 11, 2025](#discussion_r2513966603)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason
Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved
 
Hide comment

That's correct. `wrapper`'s version gets incremented instead, as the containing root object.

Sorry, something went wrong.

### Uh oh!

There was an error while loading. Please reload this page.

All reactions

[![henryachen](https://avatars.githubusercontent.com/u/8963934?s=60&v=4)](/henryachen)

**[henryachen](/henryachen)**
approved these changes
[Nov 11, 2025](#pullrequestreview-3446025767)

[View reviewed changes](/MystenLabs/sui/pull/24202/files/52d33c2c57076c852a6e0ad824eead76ab52fc5f)

Hide details
View details
[![@amnn](https://avatars.githubusercontent.com/u/332275?s=40&u=fbf218c7e4a657c413a08873087b3f79c535da22&v=4)](/amnn)
[amnn](/amnn)
merged commit [`837b22c`](/MystenLabs/sui/commit/837b22c0083f85930f7055e51678f7c77eacc037)
into

main
[Nov 11, 2025](https://github.com/MystenLabs/sui/pull/24202#event-20861009937)

53 of 54 checks passed

### Uh oh!

There was an error while loading. Please reload this page.

[![@amnn](https://avatars.githubusercontent.com/u/332275?s=40&u=fbf218c7e4a657c413a08873087b3f79c535da22&v=4)](/amnn)
[amnn](/amnn)
deleted the

amnn/gql-obj-v
 
branch
[November 11, 2025 11:58](#event-20861011559)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fpull%2F24202)

### Reviewers

[![@henryachen](https://avatars.githubusercontent.com/u/8963934?s=40&v=4)](/henryachen) [henryachen](/henryachen)

henryachen approved these changes

[![@emmazzz](https://avatars.githubusercontent.com/u/14351986?s=40&v=4)](/emmazzz) [emmazzz](/emmazzz)






 Awaiting requested review from emmazzz






 emmazzz is a code owner automatically assigned from MystenLabs/devx-indexers-and-rpcs

[![@wlmyng](https://avatars.githubusercontent.com/u/127570466?s=40&v=4)](/wlmyng) [wlmyng](/wlmyng)






 Awaiting requested review from wlmyng






 wlmyng is a code owner automatically assigned from MystenLabs/devx-indexers-and-rpcs

[![@tpham-mysten](https://avatars.githubusercontent.com/u/214580142?s=40&v=4)](/tpham-mysten) [tpham-mysten](/tpham-mysten)






 Awaiting requested review from tpham-mysten






 tpham-mysten is a code owner automatically assigned from MystenLabs/devx-indexers-and-rpcs

[![@evan-wall-mysten](https://avatars.githubusercontent.com/u/219740240?s=40&v=4)](/evan-wall-mysten) [evan-wall-mysten](/evan-wall-mysten)






 Awaiting requested review from evan-wall-mysten






 evan-wall-mysten is a code owner automatically assigned from MystenLabs/devx-indexers-and-rpcs

### Assignees

[![@amnn](https://avatars.githubusercontent.com/u/332275?s=40&v=4)](/amnn) [amnn](/amnn)

### Labels

None yet

### Projects

None yet

### Milestone

No milestone

### Development

Successfully merging this pull request may close these issues.

### Uh oh!

There was an error while loading. Please reload this page.

### 3 participants

[![@amnn](https://avatars.githubusercontent.com/u/332275?s=52&v=4)](/amnn) [![@henryachen](https://avatars.githubusercontent.com/u/8963934?s=52&v=4)](/henryachen)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

You can’t perform that action at this time.