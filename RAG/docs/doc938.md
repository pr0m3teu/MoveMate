[consensus] fix deadlock during recovery (#24292) · MystenLabs/sui@d2d56a6 · GitHub



[Skip to content](#start-of-content)








## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fcommit%2Fd2d56a65d384b7c8110af59ac8cfcf2b6a215efa)

Appearance settings

Search or jump to...


# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.


Include my email address so I can be contacted

Cancel
 Submit feedback





# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

Cancel
 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FMystenLabs%2Fsui%2Fcommit%2Fd2d56a65d384b7c8110af59ac8cfcf2b6a215efa)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcommit%2Fshow&source=header-repo&source_repo=MystenLabs%2Fsui)

Appearance settings

Resetting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.
 


Dismiss alert

{{ message }}

[MystenLabs](/MystenLabs) 
/
**[sui](/MystenLabs/sui)**
Public

* [Notifications](/login?return_to=%2FMystenLabs%2Fsui) You must be signed in to change notification settings
* [Fork
  11.7k](/login?return_to=%2FMystenLabs%2Fsui)
* [Star
   7.5k](/login?return_to=%2FMystenLabs%2Fsui)

# Commit d2d56a6

[Browse files](/MystenLabs/sui/tree/d2d56a65d384b7c8110af59ac8cfcf2b6a215efa)Browse files

[![mwtian](https://avatars.githubusercontent.com/u/81660174?v=4&size=40)](/mwtian)[mwtian](/MystenLabs/sui/commits?author=mwtian)

committed

[consensus] fix deadlock during recovery ([#24292](https://github.com/MystenLabs/sui/pull/24292))

## Description
[#24024](https://github.com/MystenLabs/sui/pull/24024) introduced a potential
deadlock when recovering consensus. Possible sequence of events:
1. Thread A: acquires `dag\_state` read lock for the duration of the
function call in
`recover\_blocks\_after\_round(observer.dag\_state.read().gc\_round())`
2. Thread B: `CommitFinalizer::run()` tries to acquire the `dag\_state`
write lock, and is blocked on the reader lock from (1)
3. Thread A: `recover\_and\_vote\_on\_blocks()` tries to acquire read lock
on `dag\_state` again. This usually succeeds but in this case because of
(2), this is blocked, causing a deadlock.
Also:
- Run the last step of `TransactionCertifier` recovery in a blocking
thread.
- Improve logging.
## Test plan
CI
The affected validator is fixed.

```move
1 parent 78afac0 commit d2d56a6

Copy full SHA for d2d56a6
```

## File tree

Expand file treeCollapse file tree

## 4 files changed

+28

-9

lines changed

Open diff view settings

Filter options

* consensus/core/src

  + [commit\_observer.rs](#diff-c1331fcd0f3e68990a19cd36f301d7bbbf45cad6830ed3803b6949793d832f05)
  + [transaction\_certifier.rs](#diff-3ca4e94a72c414af13dcd432146c5e237f545226a0582b689a5b0e6f2895ad40)
* crates/sui-core/src

  + [authority\_server.rs](#diff-87bd2349f75c8096f4bd65152a5735a2ea0690f54180196ec497c19486a2f593)
  + [consensus\_validator.rs](#diff-72c1b2954bf06de16f1a80e8c975778a28899c114a610cb1444152a1d8f245f5)

Expand file treeCollapse file tree

## 4 files changed

+28

-9

lines changed

Open diff view settings

Collapse file

### [`‎consensus/core/src/commit_observer.rs‎`](#diff-c1331fcd0f3e68990a19cd36f301d7bbbf45cad6830ed3803b6949793d832f05)

Copy file name to clipboardExpand all lines: consensus/core/src/commit\_observer.rs

+10-3Lines changed: 10 additions & 3 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -77,9 +77,16 @@ impl CommitObserver {` | | | |
| `77` | `77` | `// Recover blocks needed for future commits (and block proposals).` |
| `78` | `78` | `// Some blocks might have been recovered as committed blocks in recover_and_send_commits().` |
| `79` | `79` | `// They will just be ignored.` |
| `80` |  | `- observer` |
| `81` |  | `- .transaction_certifier` |
| `82` |  | `- .recover_blocks_after_round(observer.dag_state.read().gc_round());` |
|  | `80` | `+ tokio::runtime::Handle::current()` |
|  | `81` | `+ .spawn_blocking({` |
|  | `82` | `+ let transaction_certifier = observer.transaction_certifier.clone();` |
|  | `83` | `+ let gc_round = observer.dag_state.read().gc_round();` |
|  | `84` | `+ move || {` |
|  | `85` | `+ transaction_certifier.recover_blocks_after_round(gc_round);` |
|  | `86` | `+ }` |
|  | `87` | `+ })` |
|  | `88` | `+ .await` |
|  | `89` | `+ .expect("Spawn blocking should not fail");` |
| `83` | `90` |  |
| `84` | `91` | `observer` |
| `85` | `92` | `}` |
|  | | | |

Collapse file

### [`‎consensus/core/src/transaction_certifier.rs‎`](#diff-3ca4e94a72c414af13dcd432146c5e237f545226a0582b689a5b0e6f2895ad40)

Copy file name to clipboardExpand all lines: consensus/core/src/transaction\_certifier.rs

+14-4Lines changed: 14 additions & 4 deletions

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -100,7 +100,7 @@ impl TransactionCertifier {` | | | |
| `100` | `100` | `.scan_blocks_by_author(authority_index, recovery_start_round)` |
| `101` | `101` | `.unwrap();` |
| `102` | `102` | `info!(` |
| `103` |  | `- "Recovering and voting on {} blocks for authority {} {}",` |
|  | `103` | `+ "Recovered and voting on {} blocks from authority {} {}",` |
| `104` | `104` | `blocks.len(),` |
| `105` | `105` | `authority_index,` |
| `106` | `106` | `context.committee.authority(authority_index).hostname` |
| `@@ -116,11 +116,21 @@ impl TransactionCertifier {` | | | |
| `116` | `116` | `/// Because own votes on blocks are not stored, input blocks are voted on if they can be` |
| `117` | `117` | `/// included in a future proposed block.` |
| `118` | `118` | `pub(crate) fn recover_and_vote_on_blocks(&self, blocks: Vec<VerifiedBlock>) {` |
| `119` |  | `- let dag_state = self.dag_state.read();` |
|  | `119` | `+ let (gc_round, hard_linked) = {` |
|  | `120` | `+ let dag_state = self.dag_state.read();` |
|  | `121` | `+ (` |
|  | `122` | `+ dag_state.gc_round(),` |
|  | `123` | `+ blocks` |
|  | `124` | `+ .iter()` |
|  | `125` | `+ .map(|b| dag_state.is_hard_linked(&b.reference()))` |
|  | `126` | `+ .collect::<Vec<_>>(),` |
|  | `127` | `+ )` |
|  | `128` | `+ };` |
| `120` | `129` | `let voted_blocks = blocks` |
| `121` | `130` | `.into_iter()` |
| `122` |  | `- .map(|b| {` |
| `123` |  | `- if b.round() <= dag_state.gc_round() || dag_state.is_hard_linked(&b.reference()) {` |
|  | `131` | `+ .zip(hard_linked)` |
|  | `132` | `+ .map(|(b, linked)| {` |
|  | `133` | `+ if b.round() <= gc_round || linked {` |
| `124` | `134` | `// Voting is unnecessary for blocks already included in own proposed blocks,` |
| `125` | `135` | `// or outside of local DAG GC bound.` |
| `126` | `136` | `(b, vec![])` |
|  | | | |

Collapse file

### [`‎crates/sui-core/src/authority_server.rs‎`](#diff-87bd2349f75c8096f4bd65152a5735a2ea0690f54180196ec497c19486a2f593)

Copy file name to clipboardExpand all lines: crates/sui-core/src/authority\_server.rs

+1-1Lines changed: 1 addition & 1 deletion

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -1441,7 +1441,7 @@ impl ValidatorService {` | | | |
| `1441` | `1441` | `Ok((tonic::Response::new(response), Weight::zero()))` |
| `1442` | `1442` | `}` |
| `1443` | `1443` |  |
| `1444` |  | `- #[instrument(name= "ValidatorService::wait_for_effects_response", level = "error", skip_all, err(level = "debug"), fields(consensus_position = ?request.consensus_position, fast_path_effects = tracing::field::Empty))]` |
|  | `1444` | `+ #[instrument(name= "ValidatorService::wait_for_effects_response", level = "error", skip_all, fields(consensus_position = ?request.consensus_position, fast_path_effects = tracing::field::Empty))]` |
| `1445` | `1445` | `async fn wait_for_effects_response(` |
| `1446` | `1446` | `&self,` |
| `1447` | `1447` | `request: WaitForEffectsRequest,` |
|  | | | |

Collapse file

### [`‎crates/sui-core/src/consensus_validator.rs‎`](#diff-72c1b2954bf06de16f1a80e8c975778a28899c114a610cb1444152a1d8f245f5)

Copy file name to clipboardExpand all lines: crates/sui-core/src/consensus\_validator.rs

+3-1Lines changed: 3 additions & 1 deletion

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| `@@ -176,7 +176,7 @@ impl SuiTxValidator {` | | | |
| `176` | `176` |  |
| `177` | `177` | `let tx_digest = *tx.digest();` |
| `178` | `178` | `if let Err(error) = self.vote_transaction(&epoch_store, tx) {` |
| `179` |  | `- debug!(?tx_digest, "Transaction rejected during voting: {error}");` |
|  | `179` | `+ debug!(?tx_digest, "Voting to reject transaction: {error}");` |
| `180` | `180` | `self.metrics` |
| `181` | `181` | `.transaction_reject_votes` |
| `182` | `182` | `.with_label_values(&[error.to_variant_name()])` |
| `@@ -191,6 +191,8 @@ impl SuiTxValidator {` | | | |
| `191` | `191` | `},` |
| `192` | `192` | `&error,` |
| `193` | `193` | `);` |
|  | `194` | `+ } else {` |
|  | `195` | `+ debug!(?tx_digest, "Voting to accept transaction");` |
| `194` | `196` | `}` |
| `195` | `197` | `}` |
| `196` | `198` |  |
|  | | | |

## 0 commit comments

Comments

0 (0)

You can’t perform that action at this time.